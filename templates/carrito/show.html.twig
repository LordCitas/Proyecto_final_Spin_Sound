{% extends 'base.html.twig' %}

{% block title %}Spin&Sound | Carrito de Compras{% endblock %}

{% block body %}
<main class="flex-grow">
    <div class="mx-auto max-w-4xl px-4 py-8 sm:px-6 sm:py-12 lg:px-8">
        <div class="space-y-8">
            <div>
                <nav aria-label="Breadcrumb">
                    <ol class="flex items-center gap-1.5 text-sm">
                        <li><a href="{{ path('app_home') }}" style="color: #e00000;" class="text-on-surface-muted-dark hover:text-primary">Inicio</a></li>
                        <li><span style="color: #e00000;" class="text-on-surface-muted-dark">/</span></li>
                        <li><span class="font-medium text-white">Carrito</span></li>
                    </ol>
                </nav>
                <h2 class="mt-4 text-3xl font-bold tracking-tight text-white sm:text-4xl">Tu Carrito</h2>
            </div>

            {% set detalles = carrito.detalleCarritos %}
            {% set subtotal = 0 %}
            {% for d in detalles %}
                {% set subtotal = subtotal + (d.precio * d.cantidad) %}
            {% endfor %}
            {% set shipping = subtotal > 0 ? 5.00 : 0.00 %}

            <div class="grid grid-cols-1 gap-12 lg:grid-cols-3 lg:items-start">

                {# Lista de items #}
                <div class="space-y-6 lg:col-span-2">
                    <div class="divide-y divide-surface-dark rounded-lg border border-surface-dark bg-surface-dark">
                        {% if detalles|length > 0 %}
                            {% for detalle in detalles %}
                                {% set vinilo = detalle.vinilo %}
                                <article class="flex items-center gap-4 p-4">

                                    {# Imagen #}
                                    <a href="{{ vinilo ? path('app_vinilo_show', {id: vinilo.id}) : '#' }}"
                                       class="h-20 w-20 flex-shrink-0 rounded-lg overflow-hidden bg-background-dark flex items-center justify-center">
                                        {% if vinilo and vinilo.imagen %}
                                            <img src="{{ vinilo.imagen }}" alt="{{ vinilo.titulo }}" class="h-full w-full object-cover">
                                        {% else %}
                                            <svg fill="currentColor" class="h-10 w-10 text-on-surface-muted-dark" viewBox="0 0 256 256">
                                                <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm40-96a40,40,0,1,1-40-40A40,40,0,0,1,168,120Zm-16,0a24,24,0,1,0-24,24A24,24,0,0,0,152,120Z"/>
                                            </svg>
                                        {% endif %}
                                    </a>

                                    {# Info #}
                                    <div class="flex-1 min-w-0">
                                        <a href="{{ vinilo ? path('app_vinilo_show', {id: vinilo.id}) : '#' }}"
                                           class="font-semibold text-white hover:text-primary truncate block">
                                            {{ vinilo ? vinilo.titulo : '—' }}
                                        </a>
                                        {% if vinilo and vinilo.artistas.first %}
                                            <p class="text-sm text-on-surface-muted-dark">{{ vinilo.artistas.first.nombre }}</p>
                                        {% endif %}
                                        <p class="text-sm text-primary font-bold mt-1">{{ detalle.precio|number_format(2, ',', '.') }} €</p>
                                    </div>

                                    {# Cantidad #}
                                    <div class="flex items-center gap-2">
                                        <form method="post" action="{{ path('app_carrito_update_cantidad') }}">
                                            <input type="hidden" name="_token" value="{{ csrf_token('update-cart') }}">
                                            <input type="hidden" name="detalle_id" value="{{ detalle.id }}">
                                            <input type="hidden" name="accion" value="menos">
                                            <button type="submit" class="h-8 w-8 flex items-center justify-center rounded-full border border-surface-dark text-on-surface-muted-dark hover:text-white hover:border-primary transition-colors">−</button>
                                        </form>

                                        <span class="w-8 text-center font-semibold text-white">{{ detalle.cantidad }}</span>

                                        <form method="post" action="{{ path('app_carrito_update_cantidad') }}">
                                            <input type="hidden" name="_token" value="{{ csrf_token('update-cart') }}">
                                            <input type="hidden" name="detalle_id" value="{{ detalle.id }}">
                                            <input type="hidden" name="accion" value="mas">
                                            <button type="submit" class="h-8 w-8 flex items-center justify-center rounded-full border border-surface-dark text-on-surface-muted-dark hover:text-white hover:border-primary transition-colors">+</button>
                                        </form>
                                    </div>

                                    {# Total línea #}
                                    <p class="w-20 text-right font-bold text-white">{{ (detalle.precio * detalle.cantidad)|number_format(2, ',', '.') }} €</p>

                                    {# Eliminar #}
                                    <form method="post" action="{{ path('app_carrito_remove_item') }}">
                                        <input type="hidden" name="_token" value="{{ csrf_token('remove-cart') }}">
                                        <input type="hidden" name="detalle_id" value="{{ detalle.id }}">
                                        <button type="submit" class="text-on-surface-muted-dark hover:text-red-500 transition-colors ml-2" title="Eliminar">
                                            <svg fill="currentColor" class="h-5 w-5" viewBox="0 0 256 256">
                                                <path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm96,168H64V64H192ZM112,104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"/>
                                            </svg>
                                        </button>
                                    </form>
                                </article>
                            {% endfor %}
                        {% else %}
                            <div class="p-12 text-center text-on-surface-muted-dark">
                                <svg fill="currentColor" class="h-16 w-16 mx-auto mb-4 opacity-40" viewBox="0 0 256 256">
                                    <path d="M222.14,58.87A8,8,0,0,0,216,56H54.68L49.79,29.14A16,16,0,0,0,34.05,16H16a8,8,0,0,0,0,16h18L59.56,172.29a24,24,0,0,0,5.33,11.27,28,28,0,1,0,44.4,8.44h45.42A27.75,27.75,0,0,0,152,204a28,28,0,1,0,28-28H83.17a8,8,0,0,1-7.87-6.57L72.13,152h116a24,24,0,0,0,23.61-19.71l12.16-66.86A8,8,0,0,0,222.14,58.87Z"/>
                                </svg>
                                <p class="text-lg font-semibold">Tu carrito está vacío</p>
                                <a href="{{ path('app_vinilo_index') }}" class="mt-4 inline-block text-primary hover:underline text-sm">Ver catálogo</a>
                            </div>
                        {% endif %}
                    </div>
                </div>

                {# Resumen #}
                <div class="lg:col-span-1">
                    <div class="rounded-lg border border-surface-dark bg-surface-dark p-6">
                        <h3 class="text-lg font-semibold text-white">Resumen del pedido</h3>
                        <div class="mt-4 space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span style="color: #e00000;" class="text-on-surface-muted-dark">Subtotal</span>
                                <span class="font-medium text-white">{{ subtotal|number_format(2, ',', '.') }} €</span>
                            </div>
                            <div class="flex justify-between">
                                <span style="color: #e00000;" class="text-on-surface-muted-dark">Envío</span>
                                <span class="font-medium text-primary">{{ shipping > 0 ? shipping|number_format(2, ',', '.') ~ ' €' : 'Gratis' }}</span>
                            </div>
                            <div class="border-t border-background-dark pt-3">
                                <div class="flex justify-between text-lg font-bold">
                                    <span style="color: #e00000;" class="text-white">Total</span>
                                    <span class="text-primary">{{ (subtotal + shipping)|number_format(2, ',', '.') }} €</span>
                                </div>
                            </div>
                        </div>
                        {% if app.user %}
                        <button onclick="openPaymentModal()" class="mt-6 block w-full rounded-lg py-3 text-center text-base font-bold text-white shadow-sm transition-transform hover:scale-105" style="background-color: #e00000;">
                            Proceder al pago
                        </button>
                        {% else %}
                        <a href="{{ path('app_login') }}" class="mt-6 block w-full rounded-lg py-3 text-center text-base font-bold text-white shadow-sm transition-transform hover:scale-105" style="background-color: #e00000;">
                            Iniciar sesión para pagar
                        </a>
                        {% endif %}
                        <a href="{{ path('app_vinilo_index') }}" class="mt-3 block text-center text-sm text-on-surface-muted-dark hover:text-primary transition-colors">
                            Seguir comprando
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </div>
</main>

<!-- Modal de Pago -->
<div id="payment-modal" class="fixed inset-0 z-[200] hidden">
    <!-- Overlay -->
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closePaymentModal()"></div>
    
    <!-- Modal Content -->
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="relative bg-surface-dark border border-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="sticky top-0 bg-gradient-to-r from-[#e00000] to-[#a00000] px-6 py-4 flex items-center justify-between">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M224,48H32a8,8,0,0,0-8,8V192a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A8,8,0,0,0,224,48ZM40,112H80v32H40Zm56,0H216v32H96ZM216,64V96H40V64ZM40,160H80v32H40Zm176,32H96V160H216v32Z"></path>
                    </svg>
                    Datos de Pago
                </h2>
                <button onclick="closePaymentModal()" class="text-white hover:opacity-80 transition-opacity">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path>
                    </svg>
                </button>
            </div>

            <!-- Form -->
            <form method="post" action="{{ path('app_pedido_procesar') }}" class="p-6 space-y-6">
                <input type="hidden" name="_token" value="{{ csrf_token('process-payment') }}">
                <!-- Datos de la Tarjeta -->
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4">Información de la Tarjeta</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-white mb-2">Número de Tarjeta</label>
                            <input type="text" placeholder="1234 5678 9012 3456" maxlength="19" class="w-full px-4 py-3 bg-[#0b0f13] border border-gray-700 rounded-lg text-white focus:border-[#e00000] focus:outline-none focus:ring-2 focus:ring-[#e00000]/20 transition-all">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-white mb-2">Fecha de Expiración</label>
                                <input type="text" placeholder="MM/AA" maxlength="5" class="w-full px-4 py-3 bg-[#0b0f13] border border-gray-700 rounded-lg text-white focus:border-[#e00000] focus:outline-none focus:ring-2 focus:ring-[#e00000]/20 transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-white mb-2">CVV</label>
                                <input type="text" placeholder="123" maxlength="3" class="w-full px-4 py-3 bg-[#0b0f13] border border-gray-700 rounded-lg text-white focus:border-[#e00000] focus:outline-none focus:ring-2 focus:ring-[#e00000]/20 transition-all">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-white mb-2">Titular de la Tarjeta</label>
                            <input type="text" placeholder="Nombre completo" class="w-full px-4 py-3 bg-[#0b0f13] border border-gray-700 rounded-lg text-white focus:border-[#e00000] focus:outline-none focus:ring-2 focus:ring-[#e00000]/20 transition-all">
                        </div>
                    </div>
                </div>

                <!-- Dirección de Facturación -->
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4">Dirección de Facturación</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-white mb-2">Dirección</label>
                            <input type="text" placeholder="Calle, número, piso" class="w-full px-4 py-3 bg-[#0b0f13] border border-gray-700 rounded-lg text-white focus:border-[#e00000] focus:outline-none focus:ring-2 focus:ring-[#e00000]/20 transition-all">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-white mb-2">Ciudad</label>
                                <input type="text" placeholder="Ciudad" class="w-full px-4 py-3 bg-[#0b0f13] border border-gray-700 rounded-lg text-white focus:border-[#e00000] focus:outline-none focus:ring-2 focus:ring-[#e00000]/20 transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-white mb-2">Código Postal</label>
                                <input type="text" placeholder="28001" maxlength="5" class="w-full px-4 py-3 bg-[#0b0f13] border border-gray-700 rounded-lg text-white focus:border-[#e00000] focus:outline-none focus:ring-2 focus:ring-[#e00000]/20 transition-all">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumen -->
                <div class="bg-[#0b0f13] border border-gray-800 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-white mb-3">Resumen del Pedido</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-on-surface-muted-dark">Subtotal</span>
                            <span class="text-white font-medium">{{ subtotal|number_format(2, ',', '.') }} €</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-on-surface-muted-dark">Envío</span>
                            <span class="text-white font-medium">{{ shipping|number_format(2, ',', '.') }} €</span>
                        </div>
                        <div class="border-t border-gray-800 pt-2 mt-2">
                            <div class="flex justify-between text-lg font-bold">
                                <span class="text-white">Total</span>
                                <span style="color: #e00000;">{{ (subtotal + shipping)|number_format(2, ',', '.') }} €</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-[#e00000] hover:bg-[#c00000] text-white font-bold px-6 py-3 rounded-lg transition-all hover:scale-105 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96ZM208,208H48V96H208V208Zm-68-56a12,12,0,1,1-12-12A12,12,0,0,1,140,152Z"></path>
                        </svg>
                        Confirmar Pago
                    </button>
                    <button type="button" onclick="closePaymentModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold px-6 py-3 rounded-lg transition-all">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openPaymentModal() {
    document.getElementById('payment-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closePaymentModal() {
    document.getElementById('payment-modal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}
</script>
{% endblock %}
