{% extends 'base.html.twig' %}

{% block title %}Spin&Sound | Carrito de Compras{% endblock %}

{% block javascripts %}
    {{ parent() }}
{% endblock %}

{% block body %}
<main class="flex-grow">
    <div class="mx-auto max-w-4xl px-4 py-8 sm:px-6 sm:py-12 lg:px-8">
        <div class="space-y-8">
            <div>
                <nav aria-label="Breadcrumb">
                    <ol class="flex items-center gap-1.5 text-sm">
                        <li>
                            <a style="color: #e00000;" class="text-text-muted-light transition-colors hover:text-primary dark:text-text-muted-dark dark:hover:text-primary" href="#">Inicio</a>
                        </li>
                        <li><span style="color: #e00000;" class="text-text-muted-light dark:text-text-muted-dark">/</span></li>
                        <li>
                            <span class="font-medium text-text-light dark:text-text-dark">Carrito</span>
                        </li>
                    </ol>
                </nav>
                <h2 class="mt-4 text-3xl font-bold tracking-tight text-text-light dark:text-text-dark sm:text-4xl">Tu Carrito</h2>
            </div>

            <div class="grid grid-cols-1 gap-12 lg:grid-cols-3 lg:items-start">
                <div class="space-y-6 lg:col-span-2">
                    <div class="divide-y divide-subtle-light rounded-lg border border-subtle-light bg-surface-light dark:divide-subtle-dark dark:border-subtle-dark dark:bg-surface-dark">

                        {# Contenedor donde se renderizan los items del carrito (ahora con lógica Twig). #}
                        <div id="cart-items" class="p-0">
                            {% set subtotal = 0 %}

                            {% if carrito and carrito.getDetalleCarritos|length > 0 %}
                                {% for detalle in carrito.getDetalleCarritos %}
                                    {% set vinilo = detalle.getVinilo() %}
                                    {% set lineTotal = (detalle.getPrecio() ?: 0) * (detalle.getCantidad() ?: 0) %}
                                    {% set subtotal = subtotal + lineTotal %}

                                    <article class="flex items-center gap-4 py-4 px-4 border-b last:border-b-0">
                                        <a href="{{ vinilo ? path('app_vinilo_show', {'id': vinilo.getId()}) : '#' }}" class="w-20 h-20 flex-shrink-0 rounded-md overflow-hidden bg-surface-dark">
                                            {% if vinilo and vinilo.getImagen is defined and vinilo.getImagen() %}
                                                <img src="{{ asset(vinilo.getImagen()) }}" alt="{{ vinilo.getTitulo() }}" class="w-full h-full object-cover">
                                            {% else %}
                                                <div class="w-full h-full flex items-center justify-center text-sm text-on-surface-muted-dark">Sin imagen</div>
                                            {% endif %}
                                        </a>

                                        <div class="flex-1">
                                            <a href="{{ vinilo ? path('app_vinilo_show', {'id': vinilo.getId()}) : '#' }}" class="font-semibold text-text-light dark:text-text-dark hover:text-primary">{{ vinilo ? vinilo.getTitulo() : '—' }}</a>
                                            {% if vinilo and vinilo.getArtistas() is iterable and vinilo.getArtistas()|length > 0 %}
                                                <p class="text-sm text-on-surface-muted-dark">{{ vinilo.getArtistas().first().getNombre() }}</p>
                                            {% endif %}
                                        </div>

                                        <div class="text-right">
                                            <p class="font-medium">{{ detalle.getPrecio() is not null ? '%.2f'|format(detalle.getPrecio()) ~ ' €' : '—' }}</p>
                                            <p class="text-sm text-on-surface-muted-dark">x {{ detalle.getCantidad() ?: 0 }}</p>
                                        </div>
                                    </article>
                                {% endfor %}
                            {% else %}
                                <div class="p-8 text-center text-on-surface-muted-dark">Tu carrito está vacío.</div>
                            {% endif %}

                        </div>

                    </div>
                </div>
                <div class="space-y-6 lg:col-span-1">
                    <div class="rounded-lg border border-subtle-light bg-surface-light p-6 dark:border-subtle-dark dark:bg-surface-dark">
                        <h3 class="text-lg font-semibold">Resumen del pedido</h3>
                        <div class="mt-4 space-y-3">
                            <div class="flex justify-between">
                                <span style="color: #e00000;" class="text-text-muted-light dark:text-text-muted-dark">Subtotal</span>
                                <span id="cart-subtotal" style="color: #e00000;" class="font-medium text-text-light dark:text-text-dark">{{ '%.2f'|format(subtotal) }} €</span>
                            </div>
                            <div class="flex justify-between">
                                <span style="color: #e00000;" class="text-text-muted-light dark:text-text-muted-dark">Envío</span>
                                {# envío fijo por ahora, ajustable en controlador o JS si se necesita #}
                                {% set shipping = subtotal > 0 ? 5.00 : 0.00 %}
                                <span id="cart-shipping" style="color: #e00000;" class="font-medium text-accent">{{ '%.2f'|format(shipping) }} €</span>
                            </div>
                            <div class="border-t border-subtle-light pt-3 dark:border-subtle-dark">
                                <div class="flex justify-between text-lg font-bold">
                                    <span class="text-text-light dark:text-text-dark">Total</span>
                                    <span id="cart-total" class="text-primary">{{ '%.2f'|format(subtotal + shipping) }} €</span>
                                </div>
                            </div>
                        </div>
                        <button style="background-color: #e00000;" class="mt-6 w-full rounded-lg px-5 py-3 text-base font-bold text-white shadow-sm transition-transform hover:scale-105 hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-[#e00000] focus:ring-offset-2 focus:ring-offset-background-light dark:focus:ring-offset-background-dark">
                            Proceder al pago
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}
